
#' Perform dimensionality reduction on a trajectory and the
#' respective cells
#'
#' @param name The name of the trajectory (mandatory)
#' @param traj The trajectory itself. TODO: explain format
#'
#' @export
dimensionality_reduce_trajectory <- function(name, traj) {
  # retrieve information on milestones
  names_milestones <- colnames(traj$cells)
  if (length(names_milestones) <= 12) {
    colour_milestones <- RColorBrewer::brewer.pal(max(3, length(names_milestones)), "Set3")[seq_along(names_milestones)]
    colours_milestones <- setNames(colour_milestones, names_milestones)
  } else {
    colours_milestones <- setNames(sample(rainbow(length(names_milestones))), names_milestones)
  }
  colours_rgb_milestones <- t(col2rgb(colours_milestones))

  # get structure
  structure <- traj$structure

  # structure <- bind_rows(structure, bind_rows(lapply(names_milestones, function(x) {
  #   strx <- structure %>% filter(from == x)
  #   if (nrow(strx) > 1) {
  #     expand.grid(from = strx$to, to = strx$to, length = 1, stringsAsFactors = F)
  #   }
  # })))
  gr <- igraph::graph_from_data_frame(structure, vertices = names_milestones)

  # retrieve information on cells
  pct_cells <- traj$cells
  colours_rgb_cells <- as.matrix(pct_cells) %*% colours_rgb_milestones
  colours_cells <- mapply(colours_rgb_cells[,1], colours_rgb_cells[,2], colours_rgb_cells[,3], FUN = rgb, maxColorValue = 256)

  # reduce dimensionality on structure
  gr_space_milestones <- layout_with_kk(gr, weights = E(gr)$length, maxiter = 200) %>% SCORPIUS::rescale.and.center()
  dimnames(gr_space_milestones) <- list(names_milestones, paste0("Comp", seq_len(ncol(gr_space_milestones))))

  # project dimensionality to cells
  gr_space_cells <- as.matrix(pct_cells) %*% gr_space_milestones

  # format data
  space_milestones <- data.frame(
    name,
    milestone = names_milestones,
    gr_space_milestones,
    colour = colours_milestones,
    stringsAsFactors = F)
  space_lines <- data.frame(
    name,
    from = gr_space_milestones[structure$from,,drop=F],
    to = gr_space_milestones[structure$to,,drop=F],
    row.names = NULL,
    stringsAsFactors = F)
  space_cells <- data.frame(
    name,
    gr_space_cells,
    colour = colours_cells,
    stringsAsFactors = F)

  list(
    name = name,
    traj = traj,
    milestones = space_milestones,
    lines = space_lines,
    cells = space_cells
  )
}

#' Plot a dimensionality reduced trajectory
#'
#' @param dimred_traj output as generated by \code{dimensionality_reduce_trajectory}
#'
#' @import ggplot2
#' @importFrom grid arrow
#'
#' @export
make_trajectory_plot <- function(dimred_traj) {
  with(dimred_traj, {
    ggplot() +
      geom_segment(aes(x = from.Comp1, xend = to.Comp1, y = from.Comp2, yend = to.Comp2), lines, size = 10, colour = "#444444", arrow = arrow(length = unit(.5, "cm"), type="closed")) +
      geom_point(aes(Comp1, Comp2, colour = colour), cells, size = 3) +
      geom_point(aes(Comp1, Comp2, colour = colour, fill = colour), milestones, size = 5, shape = 4, stroke = 2) +
      geom_text(aes(Comp1, Comp2, label = milestone), milestones, nudge_y = .05) +
      scale_colour_identity() +
      scale_fill_identity() +
      scale_x_continuous(limits = c(-.55, .55)) +
      scale_y_continuous(limits = c(-.55, .55)) +
      coord_equal() +
      labs(x = "Component 1", y = "Component 2")
  })
}
