check_or_perform_dimred <- function(object, insert_phantom_edges) {
  if (is_ti_data_wrapper(object)) {
    dimred_object <- dimred_trajectory(object, insert_phantom_edges = insert_phantom_edges)
  } else if (is_ti_dimred_wrapper(object)) {
    dimred_object <- object
  } else {
    stop(sQuote("object"), " is not an object as generated by plot_default, wrap_ti_task_data or wrap_ti_prediction.")
  }
  dimred_object
}


#' Perform dimensionality reduction on a trajectory and the respective samples in order to plot it
#'
#' @param traj_object A trajectory as generated by
#'  \code{\link{wrap_ti_task_data}} or
#'  \code{\link{wrap_ti_prediction}}
#' @param insert_phantom_edges attempt to plot bifurcating edges correctly automatically
#'
#' @importFrom igraph graph_from_data_frame layout_with_kk
#' @importFrom RColorBrewer brewer.pal
#' @importFrom grDevices col2rgb rainbow rgb
#'
#' @export
dimred_trajectory <- function(traj_object, insert_phantom_edges = TRUE) {
  name <- traj_object$id

  # retrieve some objects to work with
  cell_ids <- traj_object$cell_ids
  milestone_ids <- traj_object$milestone_ids
  num_milestones <- length(milestone_ids)
  milestone_network <- traj_object$milestone_network
  milestone_percentages <- traj_object$milestone_percentages

  # determine colours associated with each milestone
  col_milest_hex <-
    if (length(milestone_ids) <= 12) {
      RColorBrewer::brewer.pal(max(3, num_milestones), "Set3")[seq_len(num_milestones)]
    } else {
      sample(rainbow(num_milestones))
    }
  col_milest_rgb <- t(col2rgb(col_milest_hex))
  rownames(col_milest_rgb) <- names(col_milest_hex) <- milestone_ids

  # determine colour for sample by mixing milestone colours
  mix_colours <- function(milid, milpct) {
    colour_rgb <- apply(col_milest_rgb[milid,,drop=FALSE], 2, function(x) sum(x * milpct))
    do.call(rgb, as.list(c(colour_rgb, maxColorValue = 256)))
  }
  colours_samples <-
    milestone_percentages %>%
    group_by(cell_id) %>%
    summarise(colour = mix_colours(milestone_id, percentage)) %$%
    setNames(colour, cell_id)

  # add phantom links, ifneedbe
  if (insert_phantom_edges) {
    structure <- add_phantom_edges(milestone_ids, milestone_network)
  } else {
    structure <- milestone_network
  }

  # adjust weights on structure to make it easier to plot
  if (min(structure$length) * 3 < max(structure$length)) {
    structure <- structure %>% mutate(
      length = sqrt((length - min(length)) / (max(length) - min(length)) + .5)
    )
  }

  # reduce dimensionality on milestone_network
  gr <- igraph::graph_from_data_frame(structure %>% rename(weight = length), vertices = milestone_ids)
  space_milest_m <- igraph::layout_with_kk(gr, maxiter = 200) %>% scale_uniform()
  dimnames(space_milest_m) <- list(milestone_ids, paste0("Comp", seq_len(ncol(space_milest_m))))
  space_milest_df <- space_milest_m %>% as.data.frame() %>% rownames_to_column()

  # project dimensionality to samples
  mix_dimred <- function(milid, milpct) {
    apply(space_milest_m[milid,,drop=FALSE], 2, function(x) sum(x * milpct)) %>% t %>% as_data_frame
  }

  # create output for samples
  space_samples <- milestone_percentages %>%
    group_by(cell_id) %>%
    do(mix_dimred(.$milestone_id, .$percentage)) %>%
    ungroup %>%
    slice(match(cell_ids, cell_id)) %>%
    mutate(name, colour = colours_samples[cell_id])

  # create output for milestones
  space_milestones <- space_milest_df %>%
    rename(milestone_id = rowname) %>%
    mutate(
      name,
      colour = col_milest_hex[milestone_ids]
    )

  # create output for edges between milestones
  space_lines <- milestone_network %>%
    mutate(name) %>%
    left_join(space_milest_df %>% select(from = rowname, from.Comp1 = Comp1, from.Comp2 = Comp2), by = "from") %>%
    left_join(space_milest_df %>% select(to = rowname, to.Comp1 = Comp1, to.Comp2 = Comp2), by = "to")

  # return all output
  l <- lst(
    space_milestones = space_milestones,
    space_lines = space_lines,
    space_samples = space_samples
  )
  class(l) <- c("dyneval::ti_dimred_wrapper", "list")
  l
}

is_ti_dimred_wrapper <- function(object) {
  "dyneval::ti_dimred_wrapper" %in% class(object)
}

# this is solely used to create spacing between nodes in dimred_trajectory, but
# should be fixed to work well with undirected graphs
add_phantom_edges <- function(milestone_ids, milestone_network) {
  is_directed <- any(milestone_network$directed)

  phantom_links1 <- bind_rows(lapply(milestone_ids, function(x) {
    strx <- milestone_network %>%
      filter(from == x)

    if (nrow(strx) > 1) {
      strx <- strx %>%
        mutate(
          angle = seq(0, 120/360*pi*2, length.out = n()),
          x = length * cos(angle),
          y = length * sin(angle)
        )
      poss <- strx %>% select(x, y) %>% as.matrix
      rownames(poss) <- strx$to
      poss %>%
        dist %>%
        as.matrix %>%
        reshape2::melt(varnames = c("from", "to"), value.name = "length") %>%
        mutate(from = as.character(from), to = as.character(to), directed = is_directed) %>%
        filter(from != to)
    } else {
      NULL
    }
  }))
  phantom_links2 <- bind_rows(lapply(milestone_ids, function(x) {
    strx <- milestone_network %>%
      filter(to == x)

    if (nrow(strx) > 1) {
      strx <- strx %>%
        mutate(
          angle = seq(0, 120/360*pi*2, length.out = n()),
          x = length * cos(angle),
          y = length * sin(angle)
        )
      poss <- strx %>% select(x, y) %>% as.matrix
      rownames(poss) <- strx$from
      poss %>%
        dist %>%
        as.matrix %>%
        reshape2::melt(varnames = c("from", "to"), value.name = "length") %>%
        mutate(from = as.character(from), to = as.character(to), directed = is_directed) %>%
        filter(from != to)
    } else {
      NULL
    }
  }))

  bind_rows(milestone_network, phantom_links1, phantom_links2)
}
